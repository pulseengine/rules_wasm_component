# Hermetic Test Suite - Quick Reference

## ðŸš€ Quick Start

```bash
# Run all hermetic tests
./.hermetic_test.sh
```

## ðŸ“‹ What Gets Tested

| # | Test | What It Validates |
|---|------|-------------------|
| 1 | Clean build from scratch | Builds work without cached artifacts |
| 2 | WASM toolchain selection | Correct toolchain selected for WASM targets |
| 3 | System path leakage | No unexpected system paths in WASM builds |
| 4 | Hermetic WASI SDK | @wasi_sdk exists with correct constraints |
| 5 | Build reproducibility | Builds produce consistent outputs |
| 6 | Host vs WASM separation | Different toolchains for different targets |
| 7 | Environment independence | Builds work with minimal environment |

## âœ… What Fixed

### Test 5 (Reproducibility)
**Problem:** Linking errors on second build
**Fix:** Removed `--toolchain_resolution_debug`, added error handling

### Test 7 (Environment Independence)
**Problem:** Bazel not found in minimal env
**Fix:** Preserve bazel location in PATH

## ðŸ“Š Expected Results

```
======================================
Test Summary
======================================
âœ“ Test 1: Clean build from scratch
âœ“ Test 2: WASM toolchain selection
âœ“ Test 3: No system path leakage
âœ“ Test 4: Hermetic WASI SDK usage
âœ“ Test 5: Build reproducibility
âœ“ Test 6: Host vs WASM toolchain separation
âœ“ Test 7: Environment independence
======================================
Results: 7/7 tests passed

âœ… All hermetic tests passed!
```

## ðŸ”§ Troubleshooting

### Test Failures

**If Test 1 fails:**
- Check `bazel build //examples/basic:hello_component` works manually
- Verify MODULE.bazel has no syntax errors

**If Test 2/3 fail:**
- Likely due to caching - run `bazel clean --expunge`
- Check platform constraints on @wasi_sdk toolchain

**If Test 5 fails:**
- Check WASM output file exists
- Try manual: `bazel build //examples/basic:hello_component_wasm_lib_release_wasm_base`

**If Test 7 fails:**
- Check bazel is in PATH: `which bazel`
- Test manually: `env -i HOME=$HOME bazel version`

## ðŸ“š Full Documentation

- **Detailed guide**: [`docs/hermetic-testing-guide.md`](docs/hermetic-testing-guide.md)
- **Improvements doc**: [`docs/hermetic-test-improvements.md`](docs/hermetic-test-improvements.md)
- **Issue #163**: Original hermeticity investigation

## ðŸŽ¯ Key Takeaways

1. **Detection â‰  Usage**: System tools detected doesn't mean they're used
2. **Platform constraints work**: Bazel selects correct toolchain per target
3. **Your builds ARE hermetic**: Only use @wasi_sdk for WASM targets
4. **Testing is critical**: Automated tests catch hermeticity regressions

## ðŸ”„ When to Run

Run hermetic tests:
- âœ… Before creating PRs
- âœ… After MODULE.bazel changes
- âœ… After toolchain updates
- âœ… When investigating build issues
- âœ… In CI/CD pipeline

## ðŸ’¡ Pro Tips

```bash
# Quick check - just run Test 1
bazel clean --expunge && bazel build //examples/basic:hello_component

# Debug specific test
source ./.hermetic_test.sh && test_reproducibility

# Skip clean (faster, but less thorough)
# Edit script to comment out `bazel clean --expunge` in Test 1
```

## ðŸŽ“ What This Proves

After running all tests successfully, you've verified:

1. âœ… **Builds are hermetic** - No system WASI SDK dependency
2. âœ… **Platform constraints work** - Correct toolchain per target
3. âœ… **Toolchain separation works** - Host uses local_config_cc, WASM uses @wasi_sdk
4. âœ… **No path leakage** - Only hermetic paths in WASM builds
5. âœ… **Reproducible** - Consistent artifacts across builds
6. âœ… **Self-contained** - Minimal environment dependencies

**Conclusion:** Your WASM Component Model builds are fully hermetic! ðŸŽ‰
