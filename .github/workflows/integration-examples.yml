name: Integration Examples Test

# Triggers integration tests in wasm-component-examples repo
# to validate that rules changes don't break downstream users.
#
# This is an optional check - it provides early warning but
# won't block merges if the examples repo has its own issues.
#
# BREAKING CHANGE PROTOCOL:
# When introducing breaking changes, create a branch in the examples repo
# with the SAME NAME as your PR branch. The CI will automatically detect
# and test against that matching branch.
#
# Example:
#   Your PR branch: feature/new-api
#   Create in examples: feature/new-api (with updated examples)
#   CI tests: rules:feature/new-api against examples:feature/new-api

on:
  pull_request:
    branches: [main]
    # Only run for significant changes, not docs-only updates
    paths:
      - '*.bzl'
      - 'MODULE.bazel'
      - 'rust/**'
      - 'go/**'
      - 'cpp/**'
      - 'js/**'
      - 'wasm/**'
      - 'wit/**'
      - 'toolchains/**'
      - 'providers/**'

  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      examples_repo:
        description: 'Examples repository to test against'
        required: false
        default: 'pulseengine/wasm-component-examples'
        type: string

env:
  CI: true
  # The examples repository to trigger
  EXAMPLES_REPO: ${{ github.event.inputs.examples_repo || 'pulseengine/wasm-component-examples' }}

jobs:
  trigger-integration:
    name: Trigger Integration Tests
    runs-on: ubuntu-latest

    # This job requires a PAT with repo scope stored as INTEGRATION_TEST_TOKEN
    # If the secret is not configured, the job will be skipped gracefully
    steps:
      - name: Check for integration token
        id: check-token
        run: |
          if [ -z "${{ secrets.INTEGRATION_TEST_TOKEN }}" ]; then
            echo "has_token=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ INTEGRATION_TEST_TOKEN not configured - skipping integration tests"
            echo "To enable: Add a PAT with repo scope as INTEGRATION_TEST_TOKEN secret"
          else
            echo "has_token=true" >> $GITHUB_OUTPUT
          fi

      - name: Trigger examples integration test
        if: steps.check-token.outputs.has_token == 'true'
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ secrets.INTEGRATION_TEST_TOKEN }}
          repository: ${{ env.EXAMPLES_REPO }}
          event-type: test-integration
          client-payload: |
            {
              "ref": "${{ github.head_ref || github.ref_name }}",
              "repo": "${{ github.repository }}",
              "pr_number": "${{ github.event.pull_request.number }}",
              "sha": "${{ github.event.pull_request.head.sha || github.sha }}"
            }

      - name: Log integration test trigger
        if: steps.check-token.outputs.has_token == 'true'
        run: |
          echo "âœ… Triggered integration tests in ${{ env.EXAMPLES_REPO }}"
          echo ""
          echo "Test configuration:"
          echo "  Branch: ${{ github.head_ref || github.ref_name }}"
          echo "  Repository: ${{ github.repository }}"
          echo "  PR: #${{ github.event.pull_request.number }}"
          echo "  SHA: ${{ github.event.pull_request.head.sha || github.sha }}"
          echo ""
          echo "View results: https://github.com/${{ env.EXAMPLES_REPO }}/actions"

  # Alternative: Run integration tests directly in this workflow
  # This doesn't require cross-repo dispatch but duplicates the test logic
  direct-integration-test:
    name: Direct Integration Test
    runs-on: ubuntu-latest
    # Only run if we don't have the dispatch token
    # This provides a fallback for forks and repos without the secret

    steps:
      - name: Checkout rules_wasm_component (this PR)
        uses: actions/checkout@v4
        with:
          path: rules_wasm_component

      - name: Check for matching examples branch
        id: examples-branch
        run: |
          RULES_BRANCH="${{ github.head_ref || github.ref_name }}"

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "INTEGRATION TEST BRANCH RESOLUTION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Rules PR branch: $RULES_BRANCH"
          echo "Checking examples repo for matching branch..."
          echo ""

          # Check if a matching branch exists in the examples repo
          if git ls-remote --heads https://github.com/pulseengine/wasm-component-examples.git "$RULES_BRANCH" | grep -q "$RULES_BRANCH"; then
            echo "âœ… Found matching branch: $RULES_BRANCH"
            echo "   Using examples branch: $RULES_BRANCH"
            echo ""
            echo "   This means the rules PR has breaking changes that require"
            echo "   corresponding updates in the examples repo."
            echo "branch=$RULES_BRANCH" >> $GITHUB_OUTPUT
            echo "matched=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸  No matching branch found: $RULES_BRANCH"
            echo "   Using examples branch: main"
            echo ""
            echo "   This is expected for non-breaking changes."
            echo "branch=main" >> $GITHUB_OUTPUT
            echo "matched=false" >> $GITHUB_OUTPUT
          fi

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Checkout examples repository
        uses: actions/checkout@v4
        with:
          repository: pulseengine/wasm-component-examples
          ref: ${{ steps.examples-branch.outputs.branch }}
          path: examples

      - name: Setup integration test
        working-directory: examples
        run: |
          # Override MODULE.bazel to use local rules checkout
          cat >> MODULE.bazel << 'EOF'

          # Integration test override - use PR branch
          local_path_override(
              module_name = "rules_wasm_component",
              path = "../rules_wasm_component",
          )
          EOF

          echo "=== Testing against PR branch ==="
          cd ../rules_wasm_component && git log -1 --oneline
          echo ""

      - name: Install Bazelisk
        run: |
          curl -LO https://github.com/bazelbuild/bazelisk/releases/latest/download/bazelisk-linux-amd64
          chmod +x bazelisk-linux-amd64
          sudo mv bazelisk-linux-amd64 /usr/local/bin/bazel

      - name: Build examples
        working-directory: examples
        run: bazel build //...

      - name: Install Wasmtime
        run: |
          curl https://wasmtime.dev/install.sh -sSf | bash
          echo "$HOME/.wasmtime/bin" >> $GITHUB_PATH

      - name: Test Rust components
        working-directory: examples
        run: |
          echo "=== Testing hello_rust ==="
          WASM_FILE=$(bazel cquery --output=files //rust:hello_rust 2>/dev/null | head -1)
          $HOME/.wasmtime/bin/wasmtime run "$WASM_FILE"

          echo ""
          echo "=== Testing calculator ==="
          WASM_FILE=$(bazel cquery --output=files //rust:calculator 2>/dev/null | head -1)
          OUTPUT=$($HOME/.wasmtime/bin/wasmtime run "$WASM_FILE" 8 + 8)
          echo "$OUTPUT"
          echo "$OUTPUT" | grep -q "8 + 8 = 16"

      - name: Report result
        if: success()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… INTEGRATION TEST PASSED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Rules:    ${{ github.repository }}@${{ github.head_ref || github.ref_name }}"
          echo "Examples: ${{ steps.examples-branch.outputs.branch }}"
          if [ "${{ steps.examples-branch.outputs.matched }}" == "true" ]; then
            echo ""
            echo "Note: Used matching examples branch for breaking changes."
          fi
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Report failure
        if: failure()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âŒ INTEGRATION TEST FAILED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Rules:    ${{ github.repository }}@${{ github.head_ref || github.ref_name }}"
          echo "Examples: ${{ steps.examples-branch.outputs.branch }}"
          if [ "${{ steps.examples-branch.outputs.matched }}" == "false" ]; then
            echo ""
            echo "ğŸ’¡ TIP: If this is a breaking change, create a branch in"
            echo "   pulseengine/wasm-component-examples with the same name:"
            echo "   ${{ github.head_ref || github.ref_name }}"
            echo "   Update the examples to work with the new API, then re-run."
          fi
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
